{% extends "base.html" %}

{% block title %}Заказ #{{ order.id }} - Подтверждение{% endblock %}

{% block content %}
<div class="container">
    <div class="product-form-card" style="margin-bottom: 1.5rem;">
        <h2>Заказ #{{ order.id }}</h2>
        <p><strong>Покупатель:</strong> {{ order.username }}</p>
        <p><strong>Телефон:</strong> {{ order.customer_phone }}</p>
        <p><strong>Адрес доставки:</strong> {{ order.delivery_address }}</p>
        {% if order.comment %}
            <p><strong>Комментарий:</strong> {{ order.comment }}</p>
        {% endif %}
        <p><strong>Статус:</strong>
            <span class="badge badge-{{ order.status }}">{{ status_label }}</span>
        </p>
        {% if status_timeline %}
            {% set is_single_step = status_timeline|length == 1 %}
            <div class="order-status-tracker{% if is_single_step %} single-step{% endif %}">
                {% for step in status_timeline %}
                    <div class="order-status-step order-status-{{ step.state }}">
                        <div class="step-indicator">{{ loop.index }}</div>
                        <div class="step-label">{{ step.label }}</div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% if status_choices %}
            <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" class="order-status-form">
                <input type="hidden" name="next" value="{{ request.full_path }}">
                <label for="order-status-select" style="display:block; margin: 1rem 0 0.5rem;">Обновить этап заказа</label>
                <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                    <select name="status" id="order-status-select" class="form-control" style="flex:1; min-width:220px;">
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary btn-small" style="min-width:160px;">Сохранить</button>
                </div>
            </form>
        {% endif %}
    </div>

    <div class="product-form-card">
        <h3>Ваши товары в заказе</h3>
        {% for item in order_items %}
            <div class="order-item" style="margin-bottom: 0.75rem;">
                <div class="order-item-info">
                    {% if item.image %}
                        <img src="{{ image_url(item.image) }}" alt="{{ item.product_name }}" class="order-item-image">
                    {% endif %}
                    <div>
                        <strong>{{ item.product_name }}</strong><br>
                        <span class="order-item-details">
                            {{ "%.2f"|format(item.price) }} ₽ × {{ item.quantity }} шт. = {{ "%.2f"|format(item.price * item.quantity) }} ₽
                        </span>
                    </div>
                </div>
                <div class="order-item-status">
                    {% if item.seller_confirmed %}
                        <span class="text-success">✓ Подтверждено</span>
                        {% if item.confirmed_at %}
                            <br><span class="text-muted" style="font-size: 0.8rem;">{{ item.confirmed_at }}</span>
                        {% endif %}
                    {% else %}
                        <form method="POST" action="{{ url_for('confirm_order_item', order_id=order.id, order_item_id=item.id) }}" class="inline-form">
                            <button type="submit" class="btn btn-primary btn-small">Подтвердить</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <p class="text-muted">Товаров не найдено</p>
        {% endfor %}
    </div>

    <div style="margin-top: 1.5rem;">
        <a href="{{ url_for('account') }}" class="btn btn-outline">Вернуться в аккаунт</a>
    </div>
</div>
{% endblock %}

