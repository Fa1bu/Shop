{% extends "base.html" %}

{% block title %}{{ 'Редактирование товара' if is_edit else 'Добавление товара' }} - Интернет-магазин{% endblock %}

{% block content %}
<div class="container">
    <h2>{{ 'Редактировать товар' if is_edit else 'Добавить новый товар' }}</h2>
    <div class="product-form-card">
        {% if is_edit and existing_images %}
        <div class="image-gallery-manage">
            {% for image in existing_images %}
                <div class="image-thumb">
                    <img src="{{ image_url(image.image_path) }}" alt="Изображение товара">
                    <form method="POST" action="{{ url_for('delete_product_image', product_id=product.id, image_id=image.id) }}" onsubmit="return confirm('Удалить изображение?');">
                        <button type="submit" class="btn btn-outline btn-small">Удалить</button>
                    </form>
                </div>
            {% endfor %}
        </div>
        {% endif %}
        <form method="POST" action="{{ url_for('edit_product', product_id=product.id) if is_edit else url_for('add_product') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label>Название *</label>
                <input type="text" name="name" class="form-control" required value="{{ product.name if product else request.form.name }}">
            </div>
            <div class="form-group">
                <label>Описание *</label>
                <textarea name="description" class="form-control" rows="4" required>{{ product.description if product else request.form.description }}</textarea>
            </div>
            <div class="form-group">
                <label>Цена (₽) *</label>
                <input type="text" name="price" class="form-control" inputmode="decimal" pattern="^\d+(?:[.,]\d{0,2})?$" title="Введите неотрицательное число, например 1999 или 1999.99" placeholder="Например: 1234.56" required value="{{ product.price if product else request.form.price }}">
            </div>
            <div class="form-group">
                <label>Изображения товара {% if not is_edit %}*{% endif %}</label>
                <input type="file" name="images" class="form-control" accept="image/*" {% if not is_edit %}required{% endif %} multiple>
                <small style="color: #666; display: block; margin-top: 0.5rem;">
                    Загрузите одно или несколько изображений (PNG, JPG, JPEG, GIF, WEBP)
                </small>
            </div>
            <div class="form-group">
                <label>Категория *</label>
                <select name="category" class="form-control" required>
                    <option value="">Выберите категорию</option>
                    {% set selected_category = (request.form.get('category') or (product.category if product else ''))|lower %}
                    {% for cat in category_choices %}
                        <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat|capitalize }}</option>
                    {% endfor %}
                    {% if is_edit and product.category and product.category|lower not in category_choices %}
                        <option value="{{ product.category }}" selected>{{ product.category }}</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label>Количество на складе</label>
                <input type="number" min="0" name="stock" class="form-control" value="{{ product.stock if product else (request.form.stock or 0) }}">
            </div>
            <div class="form-group">
                <label>Характеристики</label>
                <textarea name="specifications" class="form-control" rows="6" placeholder="Введите характеристики в формате:&#10;Название: Значение&#10;Например:&#10;Материал: Хлопок&#10;Размер: M&#10;Цвет: Синий">{{ product.specifications if product and product.specifications else (request.form.specifications or '') }}</textarea>
                <small style="color: #666; display: block; margin-top: 0.5rem;">Введите характеристики в формате "Название: Значение", каждую на новой строке</small>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary btn-large">Сохранить</button>
                {% if is_edit %}
                    <a href="{{ url_for('product', product_id=product.id) }}" class="btn btn-outline btn-large">Отмена</a>
                    <form method="POST" action="{{ url_for('delete_product', product_id=product.id) }}" style="display: inline;" onsubmit="return confirm('Вы уверены, что хотите удалить этот товар? Это действие нельзя отменить.');">
                        <button type="submit" class="btn btn-danger btn-large">Удалить товар</button>
                    </form>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}


